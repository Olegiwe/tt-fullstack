<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Backend разработка</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=792, user-scalable=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="stylesheet" href="../../../node_modules/shower-bright/styles/screen.css">
    <link rel="stylesheet" href="../../../css/highlight/github.css">
    <link rel="stylesheet" href="../../../css/index.css">
</head>
<body class="list">
    <header class="caption">
        <h1>Backend разработка</h1>
        <p><a href="https://github.com/mialinx/">Дмитрий Смаль</a></p>
    </header>

    <section class="slide shout"><div>
        <h2>World Wide Web</h2>
    </div></section>

    <section class="slide"><div>
        <h2>World Wide Web</h2>
        <p>WWW - множество <b>взаимосвязанных документов</b>, располагающихся на машинах подключенных к Internet</p>
        <p>WWW - набор протоколов, серверного и клиентского ПО, позволяющих получать доступ к документам</p>
    </div></section>

    <section class="slide"><div>
        <img src="pictures/hyperlinks.png" class="place"/>
    </div></section>

    <section class="slide shout"><div>
        <h2>Документы</h2>
    </div></section>

    <section class="slide"><div>
        <h2>Типы документов (MIME-типы)</h2>
        <div class="lr">
            <div class="c5">
                <ul>
                    <li>text/html</li>
                    <li>text/css</li>
                    <li>text/javascript</li>
                    <li>image/png</li>
                </ul>
            </div>
            <div class="c5">
                <ul>
                    <li>video/mp4</li>
                    <li>text/xml</li>
                    <li>application/json</li>
                    <li><a href="http://www.iana.org/assignments/media-types/media-types.xhtml">Полный список MIME типов</a></li>
                </ul>
            </div>
        </div>
        <p><small>Расширения файлов играют второстепенную роль</small></p>
    </div></section>

    <section class="slide"><div>
        <h2>text/html</h2>
        <script type="snippet" lang="html">
            <html>
            <body>
              <link rel="stylesheet" href="/css/style.css">
              <script src="http://code.jquery.com/jquery-2.1.4.js">
              </scr&#8203;ipt>
              <p>Some text with <img src="pic/img1.png">
                  and <a href="#yes">hyperlinks</a>
              </p>
            </body>
            </html>
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>text/css</h2>
        <script type="snippet" lang="css">
            .hljs-subst,
            .hljs-title,
            .json .hljs-value {
              font-weight: normal;
              color: #000;
            }
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>text/xml</h2>
        <script type="snippet" lang="xml">
            <response status="ok">
                <friends>
                    <friend id="1" name="v.pupkin"/>
                    <friend id="2" name="a.pushkin"/>
                    <friend id="3" name="n.tesla"/>
                </friends>
            </response>
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>application/json</h2>
        <script type="snippet" lang="json">
            {
                "status": "ok",
                "friends": [
                    { "id": 1, "name": "v.pupkin" },
                    { "id": 2, "name": "a.pushkin" },
                    { "id": 3, "name": "n.tesla" }
                ]
            }
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>Документы могут быть</h2>
        <ul>
            <li><b>Статические</b>
                <ul>
                    <li>Это файлы на дисках сервера</li>
                    <li>Как правило, обладают постоянным адресом</li>
                </ul>
            </li>
            <li><b>Динамические</b>
                <ul>
                    <li>Создаются на каждый запрос</li>
                    <li>Содержимое зависит от времени и пользователя</li>
                    <li>Адрес может быть постоянным или меняться</li>
                </ul>
            </li>
        </ul>
    </div></section>

    <section class="slide shout"><div>
        <h2>URL</h2>
    </div></section>

    <section class="slide"><div>
        <h2>URL - unified resource locator</h2>
        <code>http://server.org:8080/path/doc.html?a=1&b=2#part1</code>
        <ul>
            <li>http - протокол<br></li>
            <li>server.org - DNS имя сервера<br></li>
            <li>8080 - TCP порт<br></li>
            <li>/path/doc.html - путь к файлу<br></li>
            <li>a=1&b=2 - опции запроса<br></li>
            <li>part1 - якорь, положение на странице<br></li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Абсолютные и относительные URL</h2>
        <ul>
            <li><code>http://server.org/1.html</code> - абсолютный</li>
            <li><code>//server.org/1.html</code> - абсолютный (schemeless)</li>
            <li><code>/another/page.html?a=1</code> - относительный (в пределах домена)</li>
            <li><code>pictures/1.png</code> - относительный (от URL текущего документа)</li>
            <li><code>?a=1&amp;b=2</code> - относительный (от URL текущего документа)</li>
            <li><code>#part2</code> - относительный (в пределах текущего документа)</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Правила разрешения URL</h2>
        <code>https://site.com/path/page.html</code> - основной документ<br>
        + <code>http://wikipedia.org</code> = <code>http://wikipedia.org</code><br>
        + <code>//cdn.org/jquery.js</code> = <code><b>https</b>://cdn.org/jquery.js</code><br>
        + <code>/admin/index.html</code> = <code><b>https://site.com</b>/admin/index.html</code><br>
        + <code>another.html</code> = <code><b>https://site.com/path/</b>another.html</code><br>
        + <code>?full=1</code> = <code><b>https://site.com/path/page.html</b>?full=1</code><br>
        + <code>#chapter2</code> = <code><b>https://site.com/path/page.html</b>#chaprer2</code><br>
    </div></section>

    <section class="slide shout"><div>
        <h2>Как документы могут ссылаться друг на друга?</h2>
    </div></section>

    <section class="slide"><div>
        <h2>HTML - гиперссылки</h2>
        <script type="snippet" lang="html">
            Список товаров в <a href="/cart.php">корзине</a>
        </script>
        <p>Список товаров в <a href="/cart.php">корзине</a></p>
    </div></section>

    <section class="slide"><div>
        <h2>HTML - формы</h2>
        <script type="snippet" lang="html">
            <form action="https://duckduckgo.com/">
                <input type="text" name="q" value="">
                <input type="hidden" name="ia" value="images">
                <button type="submit">Найти</button>
            </form>
        </script>
        <form action="https://duckduckgo.com/">
            <input type="hidden" name="ia" value="images">
            <input type="text" name="q" value="">
            <button type="submit">Найти</button>
        </form>
    </div></section>

    <section class="slide"><div>
        <h2>HTML - ресурсы</h2>
        <script type="snippet" lang="html">
            <link rel="stylesheet" href="/css/index.css">
            <script src="http://code.jquery.com/jquery-2.1.4.js">
            </scr&#8203;ipt>
            <img src="pictures/network.png" width="200" >
        </script>
        <link rel="stylesheet" href="/css/style.css">
        <script src="http://code.jquery.com/jquery-2.1.4.js"></script>
        <img src="pictures/network.png" width="200" >
    </div></section>

    <section class="slide"><div>
        <h2>CSS - ресурсы</h2>
        <script type="snippet" lang="css">
            .slide {
                background-image: url(../pictures/network.png)
            }
            @font-face {
                font-family: Terminus;
                src: url(fonts/terminus.ttf);
            }
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>JavaScript - прямое указание URL</h2>
        <script type="snippet" lang="javascript">
            var saveApiUrl = '/items/save/';
            var newTitle = 'Duck tales';
            $.ajax({
                type: 'POST',
                url:  saveApiUrl,
                data: { id: 10, title: newTitle }
            });
        </script>
    </div></section>

    <section class="slide shout"><div>
        <h2>Клиент-серверная архитектура</h2>
    </div></section>

    <section class="slide shout"><div>
        <h2>Как происходит HTTP запрос ?</h2>
    </div></section>

    <section class="slide"><div>
        <h2>Как происходит HTTP запрос ?</h2>
        <ul>
            <li>Браузер анализирует введенный URL и извлекает имя хоста</li>
            <li>Используя систему DNS, браузер преобразует домен в ip адрес</li>
            <li>Устанавливает TCP соединение с web-сервером</li>
            <li>Если протокол https, устанавливает TLS соединение поверх TCP</li>
            <li>Формирует HTTP запрос, отправляет его, HTTP ответ</li>
            <li>Браузер закрывает соединение (для HTTP/1.0)</li>
            <li>Далее процесс парсинга и отображения документа ...</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <img src="pictures/stack.png" class="place" >
    </div></section>

    <section class="slide shout"><div>
        <h2>HTTP</h2>
    </div></section>

    <section class="slide"><div>
        <h2>Какие задачи решает HTTP?</h2>
        <ul>
            <li>Передача документов</li>
            <li>Передача мета-информации</li>
            <li>Авторизация</li>
            <li>Поддержка сессий</li>
            <li>Кеширование документов</li>
            <li>Согласование содержимого (negotiation)</li>
            <li>Управление соединением</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <img src="pictures/netflow.png" class="place"/>
    </div></section>

    <section class="slide"><div>
        <h2>Ключевые особенности HTTP</h2>
        <ul>
            <li>Работает поверх TCP/TLS</li>
            <li>Протокол запрос-ответ</li>
            <li>Не поддерживает состояние (соединение) - <b>stateless</b></li>
            <li><b>Текстовый</b> протокол</li>
            <li>Расширяемый протокол</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP/1.0 запрос</h2>
        <script type="snippet" lang="plain">
            GET http://www.ru/robots.txt HTTP/1.0
            Accept: text/html, text/plain
            User-Agent: telnet/hands
            If-Modified-Since: Fri, 24 Jul 2015 22:53:05 GMT
        </script>
        <p>Перевод строки - <code>\r\n</code></p>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP/1.1 запрос</h2>
        <script type="snippet" lang="plain">
            GET /robots.txt HTTP/1.1        
            Accept: text/html,application/xhtml+xml
            Accept-Encoding: gzip, deflate
            Cache-Control: max-age=0
            Connection: keep-alive
            Host: www.ru
            User-Agent: Mozilla/5.0 Gecko/20100101 Firefox/39.0
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP/1.1 ответ</h2>
        <script type="snippet" lang="plain">
            HTTP/1.1 404 Not Found
            Server: nginx/1.5.7
            Date: Sat, 25 Jul 2015 09:58:17 GMT
            Content-Type: text/html; charset=iso-8859-1
            Connection: close

            <!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
            <HTML><HEAD>...
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP запрос состоит из</h2>
        <ul>
            <li>строка запроса
                <ul>
                    <li>метод</li>
                    <li>URL документа</li>
                    <li>версия</li>
                </ul>
            </li>
            <li>заголовки</li>
            <li>тело запроса</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP методы</h2>
        <ul>
            <li><b>GET</b> - получение документа</li>
            <li><b>HEAD</b> - получение только заголовков</li>
            <li><b>POST</b> - отправка данных на сервер</li>
            <li>PUT - отправка документа на сервер (*)</li>
            <li>DELETE - удаление документа (*)</li>
            <li>CONNECT, TRACE, OPTIONS - используются редко (*)</li>
            <li>COPY, MOVE, MKCOL - расширения WebDAV (*)</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP ответ состоит из</h2>
        <ul>
            <li>строка ответа
                <ul>
                    <li>метод</li>
                    <li>URL документа</li>
                    <li>версия</li>
                </ul>
            </li>
            <li>заголовки</li>
            <li>тела ответа - документ</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP коды ответа</h2>
        <ul>
            <li>1xx - информационные</li>
            <li>2xx - успешное выполнение</li>
            <li>3xx - перенаправления</li>
            <li>4xx - ошибка на стороне клиента</li>
            <li>5xx - ошибка на стороне сервера</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP коды ответа (1)</h2>
        <ul>
            <li>200 OK - запрос успешно выполнен</li>
            <li>204 No Content - запрос успешно выполнен, но документ пуст</li>
            <li>301 Moved Permanently - документ сменил URL</li>
            <li>302 Found - повторить запрос по другому URL</li>
            <li>304 Not Modified - документ не изменился, использовать кеш</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>HTTP коды ответа (2)</h2>
        <ul>
            <li>400 Bad Request - неправильный синтаксис запроса</li>
            <li>401 Unauthorized - требуется авторизация</li>
            <li>403 Forbidden - нет доступа (неверная авторизация)</li>
            <li>404 Not Found - документ не найден</li>
            <li>500 Internal Server Error - неожиданная ошибка сервера (application)</li>
            <li>502 Bad Gateway - проксируемый сервер отвечает с ошибкой</li>
            <li>504 Gateway Timeout - проксируемый сервер не отвечает</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Заголовки HTTP (общие)</h2>
        <p>Для управления соединением и форматом сообщения (документа)</p>
        <ul>
            <li>Content-Type - MIME тип документа</li>
            <li>Content-Length - длина сообщения</li>
            <li>Content-Encoding - кодирование документа, например gzip-сжатие</li>
            <li>Transfer-Encoding - формат передачи, например, chunked</li>
            <li>Connection - управление соединением</li>
            <li>Upgrade - смена протокола</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Заголовки HTTP запросов</h2>
        <ul>
            <li>Authorization - авторизация, чаще всего логин/пароль</li>
            <li>Cookie - передача состояния (сессии) на сервер</li>
            <li>Referer - URL предыдущего документа, контекст запроса</li>
            <li>User-Agent - описание web-клиента, версия браузера</li>
            <li>If-Modified-Since - условный GET запрос</li>
            <li>Accept-* - согласование (negotiation) содержимого</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Заголовки HTTP ответов</h2>
        <ul>
            <li>Location - новый URL документа при перенаправлениях</li>
            <li>Set-Cookie - установка состояния (сессии) в браузере</li>
            <li>Last-Modified - дата последнего изменения документа</li>
            <li>Date - Дата на сервере, для согласования кешей</li>
            <li>Server - описание web-сервера, название и версия</li>
        </ul>
    </div></section>

    <section class="slide shout"><div>
        <h2>Трехзвенная архитектура</h2>
    </div></section>

    <section class="slide"><div>
        <h2>Общая архитектура</h2>
        <img src="pictures/front_back.png" class="center" >
    </div></section>

    <section class="slide"><div>
        <h2>Задачи Frontend (web) сервера</h2>
        <ul>
            <li>отдача статических документов</li>
            <li>проксирование (reverse proxy)</li>
            <li>балансировка нагрузки</li>
            <li>кеширование</li>
            <li>сборка SSI</li>
            <li>авторизация, SSL, нарезка картинок, gzip</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Reverse proxy</h2>
        <ul>
            <li>frontend (медленно) читает запрос от клиента</li>
            <li>frontend (быстро) передает запрос свободному backend</li>
            <li>backend генерирует страницу</li>
            <li>backend (быстро) возвращает ответ frontend серверу</li>
            <li>frontend (медленно) возвращает ответ клиенту</li>
        </ul>
        Результат: backend занят минимально возможное время.
    </div></section>

    <section class="slide shout"><div>
        <h2>Web сервер</h2>
    </div></section>

    <section class="slide"><div>
        <img src="pictures/servers.png" class="place">
    </div></section>

    <section class="slide"><div>
        <h2>Запуск web сервера</h2>
        <ul>
            <li>Команда на запуск<br>
                <code>sudo /etc/init.d/nginx start</code><br>
            </li>
            <li>Чтение файла конфигурации</li>
            <li>Получение порта 80</li>
            <li>Открытие (создание) логов</li>
            <li>Понижение привилегий</li>
            <li>Запуск дочерних процессов/потоков (*)</li>
            <li>Готов к обработке запроса</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Файлы web сервера</h2>
        <ul>
            <li>Конфиг <code>/etc/nginx/nginx.conf</code><br>
                <code>include /etc/nginx/sites-enabled/*</code></li>
            <li>Init-скрипт <code>/etc/init.d/nginx [start|stop|restart]</code></li>
            <li>PID-файл <code>/var/run/nginx.pid</code></li>
            <li>Error-лог <code>/var/log/nginx/error.log</code></li>
            <li>Access-лог <code>/var/log/nginx/access.log</code></li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Процессы web сервера</h2>
        <ul>
            <li>Master (root, 1 процесс)
                <ul>
                    <li>Чтение и валидация конфига</li>
                    <li>Открытие сокета (ов) и логов</li>
                    <li>Запуск и управление дочерними процессами (worker)</li>
                    <li>Graceful restart, Binary updates</li>
                </ul>
            </li>
            <li>Worker (www-data, 1+ процессов)
                <ul>
                    <li>Обработка входящих запросов</li>
                </ul>
            </li>
        </ul>
    </div></section>

    <section class="slide shout"><div>
        <h2>Конфигурация web сервера</h2>
    </div></section>

    <section class="slide"><div>
        <h2>Терминология</h2>
        <p><b>virtual host</b>, <b>вирт. хост</b> - секция конфига web сервера, отвечающая за обслуживание определенного домена</p>
        <p><b>location</b> - секция конфига, отвечающая за обслуживание определенной группы URL</p>
    </div></section>

    <section class="slide"><div>
        <script type="snippet" lang="nginx">
            user  www www;
            error_log  /var/log/nginx.error_log  info;
            http {
              include       conf/mime.types;
              default_type  application/octet-stream;
              log_format    simple '$remote_addr $request $status';
              server {
                listen        80;
                server_name   one.example.com www.one.example.com;
                access_log    /var/log/nginx.access_log simple;
                location / {
                  root        /www/one.example.com;
                }
                location ~* ^.+\.(jpg|jpeg|gif)$ {
                  root        /www/images;
                  access_log  off;
                  expires     30d;
                }
              }
            }
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>Секции и директивы</h2>
        <ul>
            <li><code>http</code> ― конфигурация для HTTP сервера</li>
            <li><code>server</code> ― конфигурация домена (вирт. Хоста)</li>
            <li><code>server_name</code> ― имена доменов</li>
            <li><code>location</code> ― локейшен, группа URL</li>
            <li><code>root</code>, <code>alias</code> ― откуда нужно брать файлы</li>
            <li><code>error_log</code> ― лог ошибок сервера</li>
            <li><code>access_log</code> ― лог запросов</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Приоритеты location в nginx</h2>
        <ul>
            <li><code>location = /img/1.jpg</code></li>
            <li><code>location ^~ /pic/</code></li>
            <li><code>location ~* \.jpg$</code></li>
            <li><code>location /img/</code></li>
        </ul>
        При одинаковом приоритете используется тот location, что находится <b>выше</b> в конфиге.
    </div></section>

    <section class="slide"><div>
        <h2>Отдача статических документов</h2>
        <script type="snippet" lang="nginx">
            location ~* ^.+\.(jpg|jpeg|gif|png)$ {
                root        /www/images;
            }
            location /sitemap/ {
                alias /home/www/generated/;
            }
        </script>
        <code>/2015/10/ae2b5.png</code> → <code>/www/images/2015/10/ae2b5.png</code><br>
        <code>/sitemap/index.xml</code> → <code>/home/www/generated/index.xml</code><br>
    </div></section>

    <section class="slide"><div>
        <h2>Атрибуты файлов и процессов</h2>
        <div class="lr">
            <div class="c4">
                У процесса есть
                <ul>
                    <li>пользователь</li>
                    <li>группа</li>
                </ul>
            </div>
            <div class="c6">
                У файла (или директории) есть
                <ul>
                    <li>пользователь (владелец)</li>
                    <li>группа</li>
                    <li>права доступа (read/write/execute)</li>
                </ul>
            </div>
        </div>
    </div></section>

    <section class="slide"><div>
        <h2>Как узнать атрибуты ?</h2>
        <script type="snippet" lang="plain">
        $ ps -o pid,euser,egroup,comm,args -C nginx
          PID EUSER    EGROUP   COMMAND
        29731 root     root     nginx: master process /usr/sbin/nginx
        29732 www-data www-data nginx: worker process
        29733 www-data www-data nginx: worker process
        29734 www-data www-data nginx: worker process
        29737 www-data www-data nginx: worker process
        </script>
        <script type="snippet" lang="plain">
        $ ls -lah www/index.html
        -rw-r--r-- 1 nuf users 156K Feb  6 21:15 www/index.html
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>Проверка доступа</h2>
        <p>Для того, чтобы открыть файл, необходимо иметь права на чтение <code>r</code> самого файла
            и на исполнение <code>x</code> директорий, в которых он находится. Наличие прав проверяется следующим образом:
            <ul>
                <li>Если совпадает пользователь <code>-<font color="red">rw-</font>r--r--</code></li>
                <li>Если совпадает группа <code>-rw-<font color="red">r--</font>r--</code></li>
                <li>Иначе <code>-rw-r--<font color="red">r--</font></code></li>
            </ul>
        </p>
    </div></section>

    <section class="slide shout"><div>
        <h2>Application сервер</h2>
    </div></section>

    <section class="slide"><div>
        <h2>Backend (application) сервер</h2>
        <p>Роль application сервера заключается в исполнении бизнес-логики приложения и генерации динамических документов.</p>
        <p>На каждый HTTP запрос application сервер запускает некоторый обработчик в приложении. Это может быть функция, класс или программа, в зависимости от технологии.</p>
    </div></section>

    <section class="slide"><div>
        <h2>Протоколы запуска приложения</h2>
        <ul>
            <li>Servlets и др. специализированные API</li>
            <li>mod_perl, mod_python, mod_php</li>
            <li>CGI</li>
            <li>FastCGI</li>
            <li>SCGI</li>
            <li>PSGI, <b>WSGI</b>, Rack</li>
        </ul>
    </div></section>

    <section class="slide shout"><div>
        <h2>WSGI</h2>
    </div></section>

    <section class="slide"><div>
        <h2>WSGI - актуальный протокол</h2>
        <p><b>WSGI</b>, PSGI, Rack - протоколы вызова функции обработчика из application сервера.
           Сам application server при этом может выполняться в отдельном процессе или совпадать с web сервером.
           Как правило, при использовании этих протоколов в качестве application сервера выступает отдельный легковесный процесс.
       </p>
    </div></section>

    <section class="slide"><div>
        <h2>WSGI - обработчик</h2>
        <script type="snippet" lang="python">
            def wsgi_application(environ, start_response):
                # бизнес-логика 
                status = '200 OK'
                headers = [
                    ('Content-Type', 'text/plain')
                ] 
                body = 'Hello, world!'.encode('utf-8') 
                start_response(status, headers)
                return [ body ]
        </script>
        В файле <code>app/main.py</code>
    </div></section>

    <section class="slide"><div>
        <h2>Web Server Gateway Interface</h2>
        <ul>
            <li>Обработчик - функция или класс (callable)</li>
            <li>Метод, QueryString, заголовки запроса - через аргумент <b>environ</b></li>
            <li>Тело запроса передается через file-handle <b>wsgi.input</b></li>
            <li>HTTP код ответа и заголовки ответа передаются через вызов функции <b>start_response</b></li>
            <li>Тело ответа возвращается в виде списка (iterable) из обработчика</li>
            <li>Поток ошибок должен быть направлен в file-handle <b>wsgi.stderr</b></li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Переменные environ</h2>
        <ul>
            <li>CGI-like переменные: <code>REQUEST_URI</code>, ...</li>
            <li><code>wsgi.version</code> - версия WSGI протокола</li>
            <li><code>wsgi.url_scheme</code> - схема текущего URL: https или http</li>
            <li><code>wsgi.input</code> - file-handle для чтения тела запроса</li>
            <li><code>wsgi.errors</code> - file-handle для вывода ошибок</li>
            <li><code>wsgi.multithreaded</code> - ...</li>
            <li><code>wsgi.multiprocess</code> - ...</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Переменные окружения CGI</h2>
        <ul>
            <li><code>REQUEST_METHOD</code> - метод запроса</li>
            <li><code>PATH_INFO</code> - путь из URL </li>
            <li><code>QUERY_STRING</code> - фрагмент URL после <code>?</code></li>
            <li><code>REMOTE_ADDR</code> - IP адрес пользователя</li>
            <li><code>CONTENT_LENGTH</code> - длина тела запроса</li>
            <li><code>HTTP_COOKIE</code> - Заголовок <code>Cookie</code></li>
            <li><code>HTTP_ANY_HEADER_NAME</code> - любой другой HTTP заголовок</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Развертывание WSGI</h2>
        <img src="pictures/wsgi.png">
    </div></section>

    <section class="slide"><div>
        <h2>Что ложится на приложение ?</h2>
        <ul>
            <li>Анализ <code>PATH_INFO</code> и выбор конкретного обработчика</li>
            <li>Разбор конкретных заголовков, например <code>Cookie</code></li>
            <li>Разбор <code>QUERY_STRING</code></li>
            <li>Разбор тела запроса:
                <ul>
                    <li>x-www-form-urlencoded</li>
                    <li>multipart/form-data</li>
                </ul>
            </li>
            <li>Вывод правильных заголовков ответа</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Установка и запуск Gunicorn</h2>
        <script type="snippet" lang="bash">
            # внутри virtualenv
            pip install gunicorn
            pip freeze > requirements.txt
         
            # находясь в директории проекта и в virtualenv
            gunicorn --chdir app main:wsgi_application

            # или из любого состояния
            /home/nuf/quack/venv/bin/gunicorn \
                --chdir /home/nuf/quack/app main:wsgi_application
        </script>
    </div></section>

    <section class="slide shout"><div>
        <h2>Настройка проксирования в nginx</h2>
    </div></section>
    
    <section class="slide"><div>
        <h2>Настройка проксирования в nginx</h2>
        <script type="snippet" lang="plain">
            proxy_set_header Host      $host;
            proxy_set_header X-Real-IP $remote_addr;
            location / {
                proxy_pass http://backend;
            }
            location /partner/ {
                proxy_pass http://www.partner.com;
            }
            location ~ \.\w\w\w?\w?$ {
                root /www/static;
            }
        </script>
    </div></section>

    <section class="slide"><div>
        <h2>Настройка upstream в nginx</h2>
        <script type="snippet" lang="plain">
            upstream backend  {
                server back1.example.com:8080 weight=1 max_fails=3;
                server back2.example.com:8080 weight=2;
                server unix:/tmp/backend.sock;
                server backup1.example.com:8080 backup;
                server backup2.example.com:8080 backup;
            }
        </script>
    </div></section>

    <div class="progress"><div></div></div>
    <script src="../../../js/highlight.pack.js"></script>
    <script src="../../../node_modules/shower-core/shower.min.js"></script>
    <script src="../../../js/init.js"></script>

</body>
</html>
